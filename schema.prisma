generator client { provider = "prisma-client-js" }

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role { CLIENT PROVIDER ADMIN }
enum BookingStatus { RESERVED IN_PROGRESS COMPLETED CANCELLED }
enum PaymentMethod { CARD CASH }
enum PaymentTiming { AT_RESERVATION AT_SERVICE }

model User {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  email            String   @unique
  passwordHash     String?
  name             String?
  phone            String?
  city             String?
  address          String?
  photoUrl         String?

  role             Role     @default(CLIENT)

  providerApproved Boolean  @default(false)
  visibleOnSite    Boolean  @default(false)
  addedByAdmin     Boolean  @default(false)

  stripeAccountId  String?

  services         Service[] @relation("ProviderServices")
  bookingsAsClient Booking[] @relation("ClientBookings")
  bookingsAsProvider Booking[] @relation("ProviderBookings")

  reviewsGiven     Review[] @relation("ReviewsGiven")
  reviewsReceived  Review[] @relation("ReviewsReceived")

  availability     AvailabilitySlot[]
}

model ServiceCategory {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  services  Service[]
}

model Service {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  name        String
  description String?
  priceCents  Int
  durationMin Int?
  commissionPercent Int?
  active      Boolean  @default(true)

  categoryId  String?
  category    ServiceCategory? @relation(fields: [categoryId], references: [id])

  providerId  String
  provider    User     @relation("ProviderServices", fields: [providerId], references: [id])

  bookings    Booking[]
}

model AvailabilitySlot {
  id         String   @id @default(cuid())
  providerId String
  provider   User     @relation(fields: [providerId], references: [id])
  startAt    DateTime
  endAt      DateTime
  createdAt  DateTime @default(now())

  @@index([providerId, startAt])
}

model Booking {
  id             String        @id @default(cuid())
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  status         BookingStatus @default(RESERVED)

  clientId       String
  client         User          @relation("ClientBookings", fields: [clientId], references: [id])

  providerId     String
  provider       User          @relation("ProviderBookings", fields: [providerId], references: [id])

  serviceId      String
  service        Service       @relation(fields: [serviceId], references: [id])

  scheduledAt    DateTime
  address        String?
  notes          String?

  paymentMethod  PaymentMethod
  paymentTiming  PaymentTiming

  totalCents     Int
  commissionCents Int

  stripePaymentIntentId String?
  stripeStatus          String?

  review        Review?
  transaction   Transaction?
}

model Review {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())

  rating      Int
  comment     String?

  bookingId   String   @unique
  booking     Booking  @relation(fields: [bookingId], references: [id])

  authorId    String
  author      User     @relation("ReviewsGiven", fields: [authorId], references: [id])

  providerId  String
  provider    User     @relation("ReviewsReceived", fields: [providerId], references: [id])
}

model Transaction {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())

  bookingId  String   @unique
  booking    Booking  @relation(fields: [bookingId], references: [id])

  amountCents Int
  feeCents    Int
  status     String
}
